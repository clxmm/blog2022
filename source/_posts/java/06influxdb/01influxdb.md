---
title: 01influxdb
toc: true
tags: influxdb
categories: 
    - [db]
    - [influxdb]
---

## 1.第**1**章 认识InfluxDB

### **1.1 InfluxDB** 的使用场景

InfluxDB 是一种时序数据库，时序数据库通常被用在监控场景，比如运维和 IOT(物联网)领域。这类数据库旨在存储时序数据并实时处理它们。

### **1.2** 为什么不用关系型数据库

#### **1.2.1** 写入性能

<!--more-->

​		关系型数据库也是支持时间戳的，也能够基于时间戳进行查询。但是，从我们的使用场景出发，需要注意数据库的写入性能。通常，关系型数据库会采用 B+树数据结构，在数据写入时，有可能会触发叶裂变，从而产生了**对磁盘的随机读写，降低写入速度**。

​		当前市面上的时序数据库通常都是采用 LSM Tree 的变种，顺序写磁盘来增强数据的写入能力,常时序数据库 都会保证在单点每秒数十万的写入能力。

<!--more-->

#### **1.2.2** 数据价值

​	我们之前说，时序数据库一般用于指标监控场景。这个场景的数据有一个非常明显的特点就是冷热差别明显。通常，指标监控只会使用近期一段时间的数据，比如我只查询某个设备最近 10 分钟的记录，10 分钟前的数据我就不再用了。那么这 10 分钟前的数据，对我们来说就是冷数据，应该被压缩放到磁盘里去来节省空间。而热数据因为经常要用，数据库就应该让它留在内存里，等待查询。而市面上的时序数据库大都有类似的设计。

#### **1.2.3** 时间不可倒流，数据只写不改

​	时序数据是描述一个实体在不同时间所处的不同状态。

​	就像是我们打开任务管理器，查看 CPU 的使用情况。我发现 CPU 占用率太高了，于是杀死了一个进程，但 10 秒前的数据不会因为我关闭进程再发生改变了。

​	这是时序数据的一大特点。与之相应，时序数据库基本上是插入操作较多，而且还没有什么更新需求。

### **1.3 1.X** 的 **TICK** 技术栈与 **2.X** 的进一步融合

​	根据上文的介绍，我们首先可以知道时序数据一般用在监控场景。大体上，数据的应用可以分为 4 步走。

- (1)数据采集
- (2)存储
- (3)查询(包括聚合操作)
- (4)报警

​	这样一看，只给一个数据库其实只能完成数据的存储和查询功能，上游的采集和下游的报警都需要自己来实现。因此 InfluxData 在 InfluxDB1.X 的时候推出了 TICK 生态来推出start 全套的解决方案。

​	TICK4 个字母分别对应 4 个组件。

- T :Telegraf -数据采集组件，收集&发送数据到InfluxDB。
- I :InfluxDB -存储数据&发送数据到Chronograf。
-  C : Chronograf - 总的用户界面，起到总的管理功能。
-  K : Kapacitor - 后台处理报警信息。

到了 2.x，TICK 进一步融合，ICK 的功能全部融入了 InfluxDB，仅需安装 InfluxDB 就能得到一个管理页面，而且附带了定时任务和报警功能。

### **1.4 influxDB** 版本比较与选型

#### **1.4.1** 版本特性比较

费试用 InfluxDB 的单节点版(开源)，想要集群等功能就需要购买企业版。不过就 InfluxDB 1.8 来说，有开源项目根据 0.11 的代码思路提供了 InfluxDB 开源的集群方案。也 有开源项目给 InfluxDB 2.3 增加了反向代理功能，让我们可以横向拓展 InfluxDB 的服务能 力。项目参考地址

InfluxDB Cluster 对应 1.8.10:https://github.com/chengshiwen/influxdb-cluster

InfluxDB Proxy 对应 1.2 - 1.8:https://github.com/chengshiwen/influx-proxy

InfluxDB Proxy 对应 2.3:https://github.com/chengshiwen/influx-proxy/tree/influxdb-v2

​	2020 年 InfluxDB 推出了 2.0 的正式版。2.x 同 1.x 相比，底层引擎原理相差不大，但会 涉及一些概念的转变(例如 db/rp 换成了 org/bucket)。另外，对于 TICK 生态来说，1.x 需 要自己配置各个组件。2.x 则是更加方便集成，有很棒的管理页面。

​	另外，在查询语言方面，1.x 是使用 InfluxQL 进行查询，它的风格近似 SQL。2.x 推出 了 FLUX 查询语言，可以使用函数与管道符，是一种更符合时序数据特性的更具表现力的 查询语言。

#### **1.4.2** 选型，本文档使用 **InfluxDB 2.4**

- 市场现状:目前企业里面用 InfluxDB 1.X 和 InfluxDB 2.X 都有人在用，数量上 InfluxDB1.X 占多一些。

- 易用性:在开发中，InfluxDB 1.X 集成生态会比较麻烦，InfluxDB 2.X 相对来说更加 便利。

- 性能:InfluxDB 1.X 和 2.X 的内核原理基本一致，性能上差距不大。

-  集群:InfluxDB 从 0.11 版本开始，就闭源了集群功能的代码。也就是说，你只能免费试用 InfluxDB 的单节点版(开源)，想要集群等功能就需要购买企业版。不过就 InfluxDB 1.8 来说，有开源项目根据 0.11 的代码思路提供了 InfluxDB 开源的集群方案。也 有开源项目给 InfluxDB 2.3 增加了反向代理功能，让我们可以横向拓展 InfluxDB 的服务能 力。

- FLUX 语言支持:自 InfluxDB 1.7 和 InfluxDB 2.0 以来，InfluxDB 推出了一门独立的

  新的查询语言 FLUX，而且作为一个独立的项目来运作。InfluxData 公司希望 FLUX 语言能 够成为一个像 SQL 一样的通用标准，而不仅仅是查询 InfluxDB 的特定语言。而且不管是 你是选择 InfluxDB 1.X 还是 2.X 最终都会接触到 FLUX。不过 2.X 对 FLUX 的支持性要更 好一些。

- InfluxDB 产品概况:

  - InfluxDB1.8在小版本上还在更新，主要是修复一些BUG，不再添加新特性
  - nfluxDB2.4这是InfluxDB较新的版本，仍然在增加新的特性。
  - InfluxDB企业版1.9需要购买，相比开源版，它有集群功能
  - InfluxDB Cloud，免部署，跑在 InfluxData 公司的云服务器上，你可以使用客户端来操作。功能上对应开源版的 2.4

- 2.x 与 1.x 的主要区别:两个版本的内核原理基本一致，性能上的差别不大。差别主要是在，权限管理方式不同，2.x TICK 的集成性比 1.x 好，1.x 中的 database 到了 2.x 中变 成了 bucket 等。

## 第**2**章 安装部署 **InfluxDB**

[InfluxDB OSS 2.7 Documentation (influxdata.com)](https://docs.influxdata.com/influxdb/v2.7/)

#### 2.2进行初始化配置

使用浏览器访问 http://hadoop102:8086。如果是安装后的首次使用，InfluxDB 会返回一 个初始化的引导界面。按照给定步骤完成操作就好。

#### 2.3创建用户和初始化存储桶

点击 GET STARTED 按钮，进入下一个步骤(添加用户)。如图所示，你需要填写、组织名称、用户名称、用户密码。

填写完后点击 CONTINUE 按钮进入下一步。

## 第**3**章 **InfluxDB** 入门(借助 **Web UI**)

借助 Web UI，我们可以更好地理解 InfluxDB 的功能划分。接下来，我们就从 Web UI入手，先了解 InfluxDB 的基本功能。

### 3.1数据源相关

#### **3.1.1 Load Data**(加载数据)

![](./img/2023/04influx01.png)

如图所示，页面上左侧的向上箭头，对应着InfluxDB Web UI的Load Data(加载数据) 页面。

#### **3.1.1.1** 上传数据文件

在 Web UI 上，你可以用文件的方式上传数据，前提是文件中的数据符合 InfluxDB 支持的类型，包括 CSV、带 Flux 注释的 CSV 和 InfluxDB 行协议。

![](./img/2023/04/influx02.png)

点击其中任意一个按钮，将进入数据的上传页面，页面中包含了详细的说明文档，包 含你的数据应该符合什么格式，你要把数据放到哪个存储桶里，还包括用命令行来上传数 据的命令模板。

#### **3.1.1.2** 写入 **InfluxDB** 的代码模板

InfluxDB 提供了各种编程语言的连接库，你甚至可以在前端嵌入向 InfluxDB 写入数据的代码，因为 InfluxDB 向外提供了一套功能完整的 REST API。

点击任何一个语言的 LOGO，你会看到使用这门语言，将数据写入到 InfluxDB 的代码 模板。

![](./img/2023/04/influx03.png)

配置 Telegraf 的输入插件

### **3.1.2** 管理存储桶

你可以将 InfluxDB 中的 bucket 理解为普通关系型数据库中的 database。在 Load data 页面上，点击上访的 BUCKETS 选项卡，就可以进入 bucket 管理页面了

#### **3.1.2.1** 创建 **Bucket**

点击右上角的 CREATE BUCKET 按钮，会有一个创建存储桶的弹窗，这里你可以给

bucket 指定一个名称和数据的过期时间。比如，你设置过期时间为 6 小时，那 InfluxDB 就 会自动把这个存储桶中距离当前时间超过 6 小时的数据删除

重命名是 InfluxDB 不建议的操作，因为大量的代码和 InfluxDB 定时任务都需要通过指定 Bucket 的名称来进行连接，贸然更改 Bucket 的名称可能导致这些程序无法正常工作。



## 第**21**章 附录 **2**:**InfluxDB** 行协议

### **21.1** 认识 **InfluxDB** 行协议

InfluxDB 行协议是 InfluxDB 数据库独创的一种数据格式，它由纯文本构成，只要数据 符合这种格式，就能使用 InfluxDB 的 HTTP API 将数据写入数据库。

与 CSV 相似，在 InfluxDB 行协议中，一条数据和另一条数据之间使用换行符分隔， 所以一行就是一条数据。另外，在时序数据库领域，一行数据一行数据由下面 4 种元素构 成。

- (1)measurement(测量名称)
- (2)Tag Set(标签集)
- 3)Field Set(字段集)
- Timestamp(时间戳)

![](./img/2023/04/influx04.png)

### **21.2 measurement**(测量名称)

**必需**

**测量的名称。**

你可以将它当作普通关系型数据的 table，虽然实际上不是这么回事。 在 InfluxDB 行协议中，测量名称不可省略。

大小写敏感

不可以用下划线_打头

### **21.3 Tag Set**(标签集)

标签应该用在一些值的范围有限(可枚举)的，不太会变动的属性上。比如传感器的 类型和 id 等等。在 InfluxDB 中一个 Tag 相当于一个索引。给数据点加上 Tag 有利于将来对 数据进行检索。但是如果索引太多了，就会减慢数据的插入速度。

**可选**

键值关系使用=表示 

多个键值对之间使用英文逗号 ,

 分隔 标签的键和值都区分大小写

 标签的键不能以下划线 _ 开头

 键的数据类型:字符串 

值的数据类型:字符串

**21.4 Field Set**(字段集)

**必需**

一个数据点上所有的字段键值对，键是字段名，值是数据点的值。 一个数据点至少要有一个字段。

字段集的键是大小写敏感的。

字段

键的数据类型:字符串

值的数据类型:浮点数 | 整数 | 无符号整数 | 字符串 | 布尔值

**21.5 Timestamp**(时间戳)

可选

数据点的 Unix 时间戳，每个数据点都可以制定自己的时间戳。

如果时间戳没有指定。那么 InfluxDB 就使用当前系统的时间戳。

数据格式： Unix

**如果你的数据里的时间戳不是以纳秒为单位的，那么需要在数据写入时指定时间戳的精度。**

### **21.6** 空格

行协议中的空格决定了 InfluxDB 如何解释数据点，第一个未转义的空格将测量值&Tag Set(标签集)与 Field Set(字段集)分开。第二个未转义空格将 Field Set(字段级)和时 间戳分开。

![](./img/2023/04/influx05.png)





